<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrimeSmsHub Dashboard</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:10px 15px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
.menu-icon{font-size:24px;cursor:pointer}
.logo img{width:80px}
.wallet button{background:#0024ff;color:#fff;padding:8px 12px;border:none;border-radius:5px;font-weight:bold}
.container{padding:20px}
.card{background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 5px rgba(0,0,0,.05);margin-bottom:20px}

.sidebar{position:fixed;top:0;left:0;width:270px;height:100%;background:#fff;box-shadow:2px 0 8px rgba(0,0,0,.08);transform:translateX(-100%);transition:.25s;z-index:3000;padding:15px;overflow-y:auto}
.sidebar.open{transform:translateX(0)}
.sidebar .close-btn{font-size:20px;cursor:pointer;margin-bottom:10px}
.sidebar nav ul{list-style:none;padding:0;margin:0}
.sidebar nav li{margin:10px 0}
.sidebar nav a{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;color:#22356f;font-weight:600;text-decoration:none}
.sidebar nav a:hover{background:#f1f5ff}
.badge{background:#e9eefc;color:#0024ff;padding:2px 7px;border-radius:12px;font-size:12px}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;transition:.2s}
.overlay.show{opacity:1;visibility:visible}

#txPanel{display:none;margin-top:10px}
.tx-item{padding:8px;border-bottom:1px solid #eee;font-size:14px}
</style>
</head>

<body>

<div class="header">
  <div class="menu-icon" id="menuIcon">‚ò∞</div>
  <div class="logo"><img src="hero.png"></div>
  <div class="wallet"><button id="walletBtn">Wallet: $0.00</button></div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="close-btn" id="closeBtn">‚úï</div>
  <nav>
    <ul>
      <li><a href="#"><span>üè†</span>Dashboard</a></li>
      <li><a href="#"><span>üì•</span>Buy Number</a></li>
      <li><a href="#"><span>üá∫üá∏</span>Buy USA Number</a></li>
      <li><a href="#"><span>üì¶</span>My Orders <span class="badge">0</span></a></li>

      <li>
        <a href="#" id="txBtn">
          <span>üí≥</span>My Transactions
          <span class="badge" id="txCount">0</span>
        </a>
        <div id="txPanel">
          <strong>Transaction History</strong>
          <div id="txList"></div>
        </div>
      </li>

      <li><a href="#"><span>‚ùì</span>Support</a></li>
      <li><a href="#" id="logoutBtn"><span>‚Ü©Ô∏è</span>Logout</a></li>
    </ul>
  </nav>
</aside>

<div class="overlay" id="overlay"></div>

<!-- CONTENT -->
<div class="container">
  <div class="card">
    <h2>Fund Wallet</h2>
    <input id="amount" type="number" placeholder="Amount (USD)"><br><br>
    <input id="phoneNumber" placeholder="Phone Number"><br><br>
    <button id="payBtn">Pay Now</button>
  </div>
</div>

<script src="https://checkout.flutterwave.com/v3.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, query, where, getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCIK3C5qAOUZUtUixX1knFRSkXAYXOCDaA",
  authDomain: "primesmshub-c0f58.firebaseapp.com",
  projectId: "primesmshub-c0f58"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const BACKEND_URL = "https://smshub-ftgg.onrender.com";

/* DOM */
const $ = id => document.getElementById(id);
const menuIcon=$("menuIcon"), sidebar=$("sidebar"), overlay=$("overlay"), closeBtn=$("closeBtn");
const walletBtn=$("walletBtn"), amountInput=$("amount"), phoneInput=$("phoneNumber"), payBtn=$("payBtn");
const txBtn=$("txBtn"), txPanel=$("txPanel"), txList=$("txList"), txCount=$("txCount"), logoutBtn=$("logoutBtn");

/* UI */
menuIcon.onclick=()=>{sidebar.classList.add("open");overlay.classList.add("show")}
closeBtn.onclick=overlay.onclick=()=>{sidebar.classList.remove("open");overlay.classList.remove("show")}

/* AUTH */
let currentUser;
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="login.html";
  currentUser=user;

  const ref=doc(db,"users",user.uid);
  if(!(await getDoc(ref)).exists())
    await setDoc(ref,{email:user.email,wallet:0,createdAt:serverTimestamp()});

  refreshWallet();
  loadTransactions();
});

/* WALLET */
async function refreshWallet(){
  const snap=await getDoc(doc(db,"users",currentUser.uid));
  walletBtn.innerText=`Wallet: $${(snap.data().wallet||0).toFixed(2)}`;
}

/* FLUTTERWAVE PAYMENT (ALL TYPES ENABLED) */
payBtn.onclick=()=>{
  const amount=Number(amountInput.value);
  const phone=phoneInput.value.trim();
  if(!amount||!phone) return alert("Fill all fields");

  FlutterwaveCheckout({
    public_key:"FLWPUBK-fcb40e4cfc07314c2a1ffaacc922d6f5-X",
    tx_ref:"PSH-"+crypto.randomUUID(),
    amount,
    currency:"USD",
    payment_options:"card,mobilemoney,ussd,banktransfer,mpesa",
    customer:{
      email:currentUser.email,
      phone_number:phone
    },
    customizations:{
      title:"PrimeSmsHub Wallet Funding",
      description:"Fund your wallet securely"
    },
    callback:data=>verifyPayment(data.transaction_id,amount)
  });
};

async function verifyPayment(txId,amount){
  const res=await fetch(`${BACKEND_URL}/flutterwave/verify/${txId}`);
  const data=await res.json();
  if(data.status!=="success") return alert("Payment failed");

  await addDoc(collection(db,"transactions"),{
    uid:currentUser.uid,
    amount,
    currency:"USD",
    txId,
    createdAt:serverTimestamp()
  });

  const ref=doc(db,"users",currentUser.uid);
  const snap=await getDoc(ref);
  await updateDoc(ref,{wallet:(snap.data().wallet||0)+amount});

  alert("Wallet funded successfully");
  refreshWallet();
  loadTransactions();
}

/* TRANSACTIONS */
async function loadTransactions(){
  const q=query(collection(db,"transactions"),where("uid","==",currentUser.uid));
  const snap=await getDocs(q);
  txList.innerHTML="";
  txCount.innerText=snap.size;
  snap.forEach(d=>{
    const t=d.data();
    txList.innerHTML+=`<div class="tx-item">$${t.amount} ‚Ä¢ ${t.currency}</div>`;
  });
}

txBtn.onclick=e=>{
  e.preventDefault();
  txPanel.style.display=txPanel.style.display==="block"?"none":"block";
};

logoutBtn.onclick=()=>signOut(auth);
</script>

</body>
</html>
